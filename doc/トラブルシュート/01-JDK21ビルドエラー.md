# JDK 21 でのビルドエラー：CallbackToFutureAdapter が見つからない

## 発生していた事象

### 問題

- ✅ `cd android && gradlew assembleDebug` → ビルド成功
- ❌ `flutter run` → ビルド失敗

### エラー内容

```
C:\Users\penguin\.gradle\caches\8.14\transforms\6ef19d1d398082c45868601482756d9f\
transformed\jetified-camera-core-1.5.0-api.jar(/androidx/camera/core/SurfaceRequest.class):
エラー: タイプ注釈@org.jspecify.annotations.NonNullをSurfaceRequest.mSurfaceRecreationCompleterに添付できません:
  androidx.concurrent.futures.CallbackToFutureAdapterのクラス・ファイルが見つかりません

FAILURE: Build failed with an exception.

* What went wrong:
Execution failed for task ':camera_android_camerax:compileDebugJavaWithJavac'.
```

### 試したこと（全て無効）

1. **依存関係追加**
   - `android/app/build.gradle.kts` に `androidx.concurrent:concurrent-futures` を追加
   - `android/build.gradle.kts` に `resolutionStrategy.force()` を追加

2. **キャッシュクリア**
   - `flutter clean` 実行
   - Gradle キャッシュ削除（`~/.gradle/caches/`）
   - Gradle Daemon 停止
   - transform キャッシュ削除

3. **バージョン調整**
   - Java 17 設定（`build.gradle.kts` 内）
   - Gradle 8.14
   - camera 0.11.0+3

4. **権限設定**
   - `AndroidManifest.xml` にカメラ権限追加

### 環境情報

- **OS**: Windows 11
- **JDK**: 21.0.4 (Amazon Corretto)
- **Gradle**: 8.14
- **Flutter**: (最新安定版)
- **Android Gradle Plugin**: 8.9.1

---

## 推測された原因

### 初期仮説（3つの解決策）

#### 解決策 1: JDK を 17 にダウングレード（推奨）

**理由**: JDK 21 + Gradle 8 の組み合わせで互換性問題が発生している可能性

**手順**:
1. JDK 17 をインストール（例: Amazon Corretto 17）
2. 環境変数 `JAVA_HOME` を JDK 17 のパスに変更
3. `flutter doctor` で Java のバージョンを確認

#### 解決策 2: build.gradle.kts の evaluationDependsOn を削除

**理由**: サブプロジェクトの評価順序が影響している可能性

**変更箇所**: `android/build.gradle.kts`

```kotlin
subprojects {
    val newSubprojectBuildDir: Directory = newBuildDir.dir(project.name)
    project.layout.buildDirectory.value(newSubprojectBuildDir)
    // この行を削除またはコメントアウト
    // project.evaluationDependsOn(":app")
}
```

#### 解決策 3: Gradle と Android Gradle Plugin のバージョン調整

**変更箇所**: `android/settings.gradle.kts`

```kotlin
id("com.android.application") version "8.3.2" apply false
id("org.jetbrains.kotlin.android") version "2.0.20" apply false
```

**変更箇所**: `android/gradle/wrapper/gradle-wrapper.properties`

```
distributionUrl=https\://services.gradle.org/distributions/gradle-8.10.2-all.zip
```

---

## 結果的な解決策

**解決策 1（JDK 17 へのダウングレード）が有効でした。**

### 実施内容

1. JDK 17.0.16 (Amazon Corretto) をインストール
2. 環境変数 `JAVA_HOME` を JDK 17 に変更
3. `flutter clean` 実行
4. `flutter run` 実行 → **成功** ✅

### 確認コマンド

```powershell
# Gradle が使用している JDK の確認
cd android
.\gradlew.bat -version
```

**出力例**:
```
Launcher JVM:  17.0.16 (Amazon.com Inc. 17.0.16+8-LTS)
Daemon JVM:    C:\Program Files\Amazon Corretto\jdk17.0.16_8
```

---

## なぜ解決策 1 で解決できたのか？

### Java はそれぞれどこで使われているのか

Flutter アプリのビルドプロセスで JDK は複数の場所で使用されます：

#### 1. **Gradle の実行（ビルドツール自体）**

```
システムの JAVA_HOME の JDK
  ↓
Gradle Daemon を起動
  ↓
Gradle タスクを実行
```

- **役割**: ビルドスクリプトの実行、依存関係の解決、タスクの管理
- **使用される JDK**: 環境変数 `JAVA_HOME` で指定された JDK

#### 2. **Android アプリのコンパイル（ソースコードのビルド）**

```
Gradle が起動した JDK の javac コンパイラ
  ↓
build.gradle.kts の設定を読む
  ↓
指定されたバージョンでコンパイル
```

- **役割**: Java/Kotlin ソースコードをバイトコードに変換
- **使用される JDK**: Gradle を動かしている JDK
- **出力されるバイトコード**: `build.gradle.kts` で指定されたバージョン（17）

#### 3. **Gradle Artifact Transform（JAR の変換）**

```
依存ライブラリ（JAR）
  ↓
JdkImageTransform（jlink を使用）
  ↓
Android 用に最適化された JAR
```

- **役割**: ライブラリを Android 環境向けに変換
- **使用される JDK**: Gradle を動かしている JDK の `jlink` ツール
- **ここで問題が発生していた** ⚠️

### build.gradle.kts の設定との関連

#### `android/app/build.gradle.kts` の設定

```kotlin
compileOptions {
    sourceCompatibility = JavaVersion.VERSION_17  // ①
    targetCompatibility = JavaVersion.VERSION_17  // ②
}

kotlinOptions {
    jvmTarget = JavaVersion.VERSION_17.toString() // ③
}
```

**これらの意味**:

- **①** `sourceCompatibility`: ソースコードは JDK 17 の文法で書かれている
- **②** `targetCompatibility`: 生成するバイトコードは JDK 17 互換にする
- **③** `jvmTarget`: Kotlin も JDK 17 バイトコードにコンパイル

**重要**: これは「JDK 17 を使え」という意味ではなく、「JDK 17 互換のコードを出力せよ」という意味。

#### JDK 21 でも JDK 17 互換のコードを出力できる

```
JDK 21 で Gradle を実行
  ↓
javac -source 17 -target 17 MyClass.java
  ↓
JDK 17 互換のバイトコードを出力
  ↓
Android 端末で動作（Android Runtime は JDK 17 相当）
```

**なので通常は問題ない** → しかし今回は Transform で失敗した

### Gradle の Artifact Transform とは？（かみ砕いた説明）

#### そもそも何のために Transform するのか

あなたのプロジェクトは：
- **開発環境**: Windows PC（JDK 17 or 21）
- **実行環境**: Android スマホ（Android Runtime）

この2つは**違うJava環境**なので、ライブラリ（JAR）をそのまま使えない場合があります。

#### Web 開発で例えると

```javascript
// npm からダウンロードしたパッケージ
node_modules/some-library/
  ├── src/ (TypeScript)
  └── package.json

  ↓ webpack/vite で変換

dist/
  └── bundle.js (ブラウザで動く JavaScript)
```

**Android 開発でも同じ**:

```
元のJAR（Java標準形式）
  ↓ JdkImageTransform
Android用JAR（最適化済み）
```

具体的には：
1. **不要なメタデータを削除**
2. **Android Runtime 用にバイトコードを調整**
3. **モジュール情報を Android 向けに書き換え**

#### 何が起きたのか（あなたのエラー）

**JDK 21 で Transform を実行した時**:

```
camera-core-1.5.0.jar
  ├── モジュール情報: platform = "android"

  ↓ JdkImageTransform (JDK 21 の jlink を使用)

JDK 21 の jlink:
  「"android" はダメ！"android-" みたいに
   ダッシュ付きじゃないと受け付けない！」

  ↓

エラー: ModuleTarget が不正な形式
  ↓
CallbackToFutureAdapter が見つからない
```

**JDK 17 で Transform を実行した時**:

```
camera-core-1.5.0.jar
  ├── モジュール情報: platform = "android"

  ↓ JdkImageTransform (JDK 17 の jlink を使用)

JDK 17 の jlink:
  「"android" でもOK！」

  ↓

変換成功 ✅
```

### なぜ `gradlew assembleDebug` は成功したのか

これには2つの可能性があります：

#### 可能性 1: Transform キャッシュが存在していた

```
以前のビルドで生成された Transform 済み JAR が
C:\Users\penguin\.gradle\caches\8.14\transforms\ に残っていた
  ↓
gradlew assembleDebug はキャッシュを再利用
  ↓
Transform をスキップ
  ↓
ビルド成功
```

#### 可能性 2: タスクの実行範囲の違い

```
gradlew assembleDebug:
  → :app プロジェクトのみビルド
  → camera_android_camerax は依存関係として解決するだけ

flutter run:
  → Flutter Gradle Plugin が全サブプロジェクトを評価
  → camera_android_camerax も含めて全部ビルド
  → Transform を実行
  → エラー発生
```

### 根本原因：JDK 21 の jlink の仕様変更

**Google Issue Tracker #317235925** によると：

> JDK 21 の `jlink` は `ModuleTarget` の `platformString` にダッシュ（`-`）を要求する
>
> - 古い形式: `"android"` → **エラー**
> - 新しい形式: `"android-"` → OK

Gradle 8.14 の `JdkImageTransform` はまだこの変更に対応していない。

### まとめ

**JDK 21 は Android 開発でまだ完全にサポートされていない**

1. **Gradle 8.4+** が JDK 21 対応に必要だが、Flutter/Android Gradle Plugin との互換性が不完全
2. **JdkImageTransform** が JDK 21 の `jlink` の新しい仕様に未対応
3. **JDK 17 が現時点で推奨される安定版**

---

## 補足：Artifact Transform に関する Q&A

### Q1: Artifact Transform はサーバーサイド（Spring Boot）でも使われる？

**A: 基本的に使われません。**

#### サーバーサイドでは不要な理由

```
Spring Boot アプリ:
  開発環境: JDK 17
  実行環境: JDK 17（同じ）
  ↓
  JAR をそのまま使える
  ↓
  Transform 不要
```

**同じ Java 環境**で開発して実行するので、ライブラリの変換が必要ない。

#### Spring Boot のビルド

```
./gradlew build
  ↓
依存関係をダウンロード
  ↓
そのまま使用（変換なし）
  ↓
Fat JAR にパッケージング
```

#### Android/モバイルで必要な理由

実行環境が特殊だから：

```
Android アプリ:
  開発環境: JDK 17（Windows/Mac）
  実行環境: Android Runtime（スマホ）← 違う！
  ↓
  Java 標準 API と Android API の違いを吸収
  ↓
  Transform が必要
```

**具体例**：

```java
// 通常のJava
java.util.concurrent.CompletableFuture

// Android
androidx.concurrent.futures.CallbackToFutureAdapter
```

このように API が違うので、ライブラリを変換する必要がある。

#### Artifact Transform が使われる場面

1. **Android 開発**（最も一般的）
   - プラットフォーム固有の最適化
   - 古い Android バージョンへの対応

2. **GraalVM Native Image**（サーバーサイドでも）
   ```
   Spring Boot アプリ
     ↓ Artifact Transform
   Native Image 用に最適化
     ↓
   ネイティブバイナリ
   ```

3. **マルチプラットフォーム対応**
   - Kotlin Multiplatform
   - JVM → JavaScript 変換
   - JVM → iOS (Kotlin/Native)

---

### Q2: Artifact Transform は Task の一種？

**A: いいえ、Task とは別の仕組みです。**

#### Gradle の2つの仕組み

##### 1. Task（タスク）

```
gradlew assembleDebug
  ↓
:app:compileDebugJavaWithJavac  ← Task
:app:processDebugResources      ← Task
:app:packageDebug               ← Task
```

- **目的**: ビルドの「手順」を定義
- **実行**: 明示的に呼び出される
- **例**: コンパイル、テスト、パッケージング

##### 2. Artifact Transform

```
依存関係を解決する時に自動で実行される
  ↓
camera-core-1.5.0.jar が必要
  ↓
でもこのままじゃ使えない
  ↓
Artifact Transform が自動で変換
  ↓
Android 用 JAR に変換完了
```

- **目的**: 依存関係の「形式」を変換
- **実行**: Gradle が自動で判断して実行
- **例**: JAR の最適化、形式変換

#### 違いを整理

| | **Task** | **Artifact Transform** |
|---|---|---|
| **いつ実行？** | 明示的に指定 | 必要な時に自動 |
| **何をする？** | ビルド手順 | 依存関係の変換 |
| **可視性** | `gradlew tasks` で見える | 裏で動く（見えにくい） |
| **Web開発で例えると** | npm scripts | webpack loader |

#### Web 開発で例えると

**Task = npm scripts**

```json
{
  "scripts": {
    "build": "tsc",      ← Task
    "test": "jest",      ← Task
    "start": "node dist" ← Task
  }
}
```

明示的に `npm run build` で実行。

**Artifact Transform = webpack loader**

```javascript
module.exports = {
  module: {
    rules: [
      {
        test: /\.ts$/,
        use: 'ts-loader'  ← Transform
      }
    ]
  }
}
```

`.ts` ファイルが必要になったら**自動で**変換される。

#### 今回のケース

```
Task `:camera_android_camerax:compileDebugJavaWithJavac` を実行
  ↓
camera-core-1.5.0.jar が必要
  ↓
Gradle が自動で判断: 「これAndroid用に変換必要だな」
  ↓
Artifact Transform (JdkImageTransform) を自動実行
  ↓
JDK 21 の jlink でエラー ❌
```

**エラーメッセージには Task 名が出るけど、実際にコケたのは Transform**だったというのがポイントです。

#### まとめ

- **Task**: ビルドの手順（明示的）
- **Artifact Transform**: 依存関係の変換（自動・暗黙的）

Artifact Transform は**Task の裏で動く別の仕組み**で、依存関係を解決する時に Gradle が自動で使います。

---

## 参考資料

- **Google Issue Tracker #317235925**: https://issuetracker.google.com/issues/317235925
  - JdkImageTransform が JDK 21 で失敗する問題
- **Flutter Issue #156304**: https://github.com/flutter/flutter/issues/156304
  - JDK 21 + Gradle 8 の互換性問題
- **Flutter Issue #156337**: https://github.com/flutter/flutter/issues/156337
  - camera_android_camerax のコンパイルエラー
- **JDK 21 javac 公式ドキュメント**: https://docs.oracle.com/en/java/javase/21/docs/specs/man/javac.html
  - `--release` オプションと後方互換コンパイル
- **Gradle Artifact Transforms**: https://docs.gradle.org/current/userguide/artifact_transforms.html
  - Transform の仕組み

---

**作成日**: 2025-10-09
**解決日**: 2025-10-09
**解決方法**: JDK 21 → JDK 17 へダウングレード
